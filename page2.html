<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Commercial Invoice</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="icon" type="image/x-icon" href="images/BID_IMPORT_logo_enhanced.ico">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      font-size: 12px;
      background: #e6e6e6;
      margin: 0;
    }

    #invoiceContent {
      width: 794px;
      min-height: 1123px;
      padding: 20px;
      margin: auto;
      background: white;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
      position: relative;
      
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 18px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid black;
      padding: 1.5px;
      text-align: left;
      word-wrap: break-word;
    }

    th:nth-child(1), td:nth-child(1) { width: 5%; }
    th:nth-child(2), td:nth-child(2) { width: 30%; }
    th:nth-child(3), td:nth-child(3) { width: 15%; }
    th:nth-child(4), td:nth-child(4) { width: 15%; }
    th:nth-child(5), td:nth-child(5) { width: 10%; }
    th:nth-child(6), td:nth-child(6) { width: 10%; }
    th:nth-child(7), td:nth-child(7) { width: 15%; }

    .section { margin-top: 5px; }
    .flex { display: flex; justify-content: space-between; flex-wrap: wrap; }

    .signature {
      display: flex;
      justify-content: space-between;
    }

    .input-area, .add-item-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
      margin-top: 5px;
    }

    label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
    }

    input, textarea {
      padding: 4px;
      font-size: 12px;
    }

    .add-button, .remove-button {
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .export-button {
      margin: 20px auto;
      display: block;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      grid-column: span 2;
    }

    .footer-fixed {
        padding-top: 10px;
        border-top: 1px solid #ccc;
        margin-top: 40px;
    }

    h5 {
      margin: 2px 0;
      font-weight: normal;
      
    }
  </style>
</head>
<body>

  <!-- Campo de seleção da empresa -->
  <label style="display: block; text-align: center; margin-bottom: 10px;">
    Company:
    <select id="companySelect" onchange="atualizarLogo()" style="margin-left: 10px; font-size: 12px;">
      <option value="bid">BID IMPORT</option>
      <option value="easy">EASYSHOP</option>
      <option value="nr">NRSHOP</option>
    </select>
  </label>

  <img id="companyLogo" src="images/BID_IMPORT_logo_enhanced.png" alt="Company Logo" style="display:block; margin: 20px auto; max-width: 150px;">

  <!-- Área de preenchimento -->
  <div class="input-area">
    <label>Date:<input id="inputData" type="date"></label>
    <label>Invoice Number:<input id="inputNumeroFatura" readonly></label>
    <label>Sender:<textarea id="inputRemetente" rows="2"></textarea></label>
    <label>Recipient:<textarea id="inputDestinatario" rows="2"></textarea></label>
    <label>Shipment Ref.:<input id="inputRefEnvio"></label>
    <label>Recipient Ref.:<input id="inputRefDestinatario"></label>
    <label>Remarks:<textarea id="inputObservacoes" rows="2"></textarea></label>
    <label><strong>Product Origin: Brazil</strong></label>
  </div>

  <p><strong>Add Item</strong></p>
  <div class="add-item-group">
    <label>Description:<input id="desc"></label>
    <label>Net Weight (kg):<input id="code"></label>
    <label>Gross Weight (kg):<input id="weight"></label>
    <label>Quantity:<input id="qty"></label>
    <label>Unit Price:<input id="unit"></label>
    <label>Total:<input id="total" readonly></label>
    <div class="action-buttons">
      <button class="add-button" onclick="addItem()">Add Item</button>
      <button class="remove-button" onclick="removeLastItem()">Remove Last Item</button>
    </div>
  </div> 

  <div class="input-area" style="max-width: 300px; margin: 0 auto;">
    <label>
      Shipping:
      <input id="shippingValue" type="number" step="0.01" value="0.00" style="text-align: right;">
    </label>
    <label>
      Other Costs:
      <input id="otherCostsValue" type="number" step="0.01" value="0.00" style="text-align: right;">
    </label>
  </div>

  <div class="input-area">
    <label>Currency:<input id="inputMoeda"></label>
    <label>Transaction Terms (Incoterms):<input id="inputIncoterms"></label>
    <label>Reason for Export:<input id="inputRazaoExportacao"></label>
    <label>Export Type:<input id="inputTipoExportacao"></label>
    <label>Carrier:<input id="inputTransportador"></label>
  </div>

  <button class="export-button" onclick="exportPDF()">Export to PDF</button>

  <!-- INVOICE A4 INTEIRA COM LOGO, TABELA E INSTRUÇÕES BANCÁRIAS -->
  <div id="invoiceContent">

    <div style="text-align: center; margin-bottom: 10px;">
      <img id="companyLogoPdf" src="images/BID_IMPORT_logo_enhanced.png" alt="Company Logo" style="max-width: 150px;">
      <h1>Commercial Invoice</h1>
    </div>

    <!-- Bloco de instruções bancárias no topo -->
    <div style="border: 1px solid #800000; padding: 3px; margin-bottom: 10px; font-size: 10px;">
      <h3 style="text-align: center; background-color: #800000; color: white; margin: 0 0 5px 0; padding: 4px; font-size: 12px;">
        BANK REFERENCES / WIRE INSTRUCTIONS - USD CITI
      </h3>
      <div style="display: flex; flex-wrap: wrap; justify-content: space-between; line-height: 1.6;">
        <div style="flex: 1 1 48%; padding-right: 5px; box-sizing: border-box;">
          <strong>Beneficiary Name:</strong> NR SHOP COMERCIAL LTDA<br>
          <strong>Beneficiary Address:</strong> RUA EDUARDO FERNANDES FILHO<br>
          <strong>IBAN:</strong> BR046214417500001009000072C1<br>
          <strong>Bank Name:</strong> BANCO PINE<br>
          <strong>SWIFT CODE:</strong> PBBRBRSPXXX<br>
        </div>
        <div style="flex: 1 1 48%; padding-left: 10px; box-sizing: border-box;">
          <strong>Bank Address:</strong> AV. Pres. Juscelino Kubitscheck, 1830 – 6º Andar<br>
          <strong>Account Number:</strong> 36887811<br>
          <strong>Intermediary Bank (if any):</strong> Citibank N.A.<br>
          <strong>SWIFT CODE:</strong> CITIUS33<br>
          <strong>ABA/ SWIFT Number:</strong> 021000089
        </div>
      </div>
    </div>



    <div class="flex">
      <div>
        <strong>Date:</strong> <span id="data"></span><br>
        <strong>Invoice:</strong> <span id="numeroFatura"></span>
      </div>
    </div>

    <div class="section flex">
      <div>
        <strong>Exporter:</strong><br>
        <span id="remetente"></span>
      </div>
      <div>
        <strong>Sent To:</strong><br>
        <span id="destinatario"></span>
      </div>
    </div>

    <table id="tabelaItens">
      <thead>
        <tr>
          <h4><strong>Product Origin: Brazil</strong></h5>
          <th>Item</th>
          <th>Description</th>
          <th>Net Weight (kg)</th>
          <th>Gross Weight (kg)</th>
          <th>QTY</th>
          <th>Unit Price</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="section" style="max-width: 300px; margin-left: auto; font-size: 12px;">
      <div style="display: flex; justify-content: space-between;">
        <strong>SUB TOTAL:</strong>
        <span id="subtotalFinal">$0.00</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 5px;">
        <strong>Shipping:</strong>
        <span id="shippingDisplay">$0.00</span>
      </div>
       <div style="display: flex; justify-content: space-between; margin-top: 5px;">
        <strong>Other Costs (Handling):</strong>
        <span id="otherCostsDisplay">$0.00</span>
    </div>
      <div style="display: flex; justify-content: space-between; margin-top: 8px; border-top: 1px solid #ccc; padding-top: 5px;">
        <strong>TOTAL:</strong>
        <span id="grandTotal">$0.00</span>
      </div>
    </div>

    <div class="section" style="display: flex; flex-wrap: wrap; gap: 10px; font-size: 11px;">

      <div style="flex: 1 1 45%;"><strong>Total Value:</strong> <span id="valorBens">$0.00</span></div>
      <div style="flex: 1 1 45%;"><strong>Total Invoice Value:</strong> <span id="valorFatura">$0.00</span></div>

      <div style="flex: 1 1 45%;"><strong>Currency:</strong> <span id="moeda"></span></div>
      <div style="flex: 1 1 45%;"><strong>Payment Conditions:</strong></div>

      <div style="flex: 1 1 45%;"><strong>Transaction Terms (Incoterms):</strong> <span id="incoterms"></span></div>
      <div style="flex: 1 1 45%;"><strong>Place of Incoterm:</strong></div>

      <div style="flex: 1 1 45%;"><strong>Reason for Export:</strong> <span id="razaoExportacao"></span></div>
      <div style="flex: 1 1 45%;"><strong>Export Type:</strong> <span id="tipoExportacao"></span></div>

      <div style="flex: 1 1 45%;"><strong>Total Net Weight:</strong> <span id="pesoLiquidoTotal">0.00 kg</span></div>
      <div style="flex: 1 1 45%;"><strong>Total Gross Weight:</strong> <span id="pesoBrutoTotal">0.00 kg</span></div>

      <div style="flex: 1 1 45%;"><strong>Total Items:</strong> <span id="totalItens">0</span></div>
      <div style="flex: 1 1 45%;"><strong>Number of Pallets:</strong> 1</div>

      <div style="flex: 1 1 45%;"><strong>Total Packages:</strong> 1</div>
      <div style="flex: 1 1 45%;"><strong>GST/VAT Paid By:</strong> Recipient</div>

      <div style="flex: 1 1 45%;"><strong>Tax/Duty Payment Account:</strong> Customer Account</div>
      <div style="flex: 1 1 45%;"><strong>Requires Customs Declaration:</strong> No</div>

      <div style="flex: 1 1 45%;"><strong>Duty/Tax Billing Service:</strong> No</div>
      <div style="flex: 1 1 45%;"><strong>Carrier:</strong> <span id="transportador"></span></div>

      <div style="flex: 1 1 100%;"><strong>Final Consignee:</strong> <span id="destinatarioFinal"></span></div>
      <div style="flex: 1 1 100%;"><strong>Exemption Statement:</strong></div>

    </div>





      <script>
    // Atualizar campos dinâmicos
    const camposAdicionais = [
      { input: "inputMoeda", span: "moeda" },
      { input: "inputIncoterms", span: "incoterms" },
      { input: "inputRazaoExportacao", span: "razaoExportacao" },
      { input: "inputTipoExportacao", span: "tipoExportacao" },
      { input: "inputTransportador", span: "transportador" },
    ];

    camposAdicionais.forEach(({ input, span }) => {
      document.getElementById(input).addEventListener("input", () => {
        document.getElementById(span).textContent = document.getElementById(input).value;
      });
    });
  </script>

  <script>
    const tbody = document.querySelector('#tabelaItens tbody');
    let itemCount = 0;

    function addItem() {
      itemCount++;

      const subtotalValue = parseFloat(document.getElementById("total").value) || 0;
      const subtotalFormatted = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(subtotalValue);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${itemCount}</td>
        <td>${desc.value}</td>
        <td>${code.value}</td>
        <td>${weight.value}</td>
        <td>${qty.value}</td>
        <td>${unit.value}</td>
        <td>${subtotalFormatted}</td>
      `;
      tbody.appendChild(tr);
      atualizarTotais();
    }

    function removeLastItem() {
      if (tbody.lastChild) {
        tbody.removeChild(tbody.lastChild);
        itemCount--;
        atualizarTotais();
      }
    }

    function atualizarTotais() {
      let pesoLiquidoTotal = 0;
      let pesoBrutoTotal = 0;
      let valorTotalFatura = 0;

      [...tbody.children].forEach(tr => {
        pesoLiquidoTotal += parseFloat(tr.children[2].textContent) || 0;
        pesoBrutoTotal += parseFloat(tr.children[3].textContent) || 0;
        const subtotal = tr.children[6].textContent.replace(/[^0-9.-]+/g, '');
        valorTotalFatura += parseFloat(subtotal) || 0;
      });

      document.getElementById("pesoLiquidoTotal").textContent = pesoLiquidoTotal.toFixed(2) + " kg";
      document.getElementById("pesoBrutoTotal").textContent = pesoBrutoTotal.toFixed(2) + " kg";
      document.getElementById("valorBens").textContent = valorTotalFatura.toLocaleString("en-US", { style: "currency", currency: "USD" });
      document.getElementById("valorFatura").textContent = document.getElementById("valorBens").textContent;
      document.getElementById("totalItens").textContent = itemCount;
      document.getElementById("destinatarioFinal").innerHTML = document.getElementById("destinatario").innerHTML;
      document.getElementById("subtotalFinal").textContent = valorTotalFatura.toLocaleString("en-US", {
      style: "currency",
      currency: "USD"
    });

    const shipping = parseFloat(document.getElementById("shippingValue").value) || 0;
const other = parseFloat(document.getElementById("otherCostsValue").value) || 0;

document.getElementById("shippingDisplay").textContent = shipping.toLocaleString("en-US", {
  style: "currency",
  currency: "USD"
});
document.getElementById("otherCostsDisplay").textContent = other.toLocaleString("en-US", {
  style: "currency",
  currency: "USD"
});

    // Soma tudo para calcular o valor total final
    const grandTotal = valorTotalFatura + shipping + other;

    // Atualiza o campo GRAND TOTAL
    document.getElementById("grandTotal").textContent = grandTotal.toLocaleString("en-US", {
      style: "currency",
      currency: "USD"
    });
    }

    const inputIds = [
      "inputData", "inputNumeroFatura", "inputRemetente",
      "inputDestinatario", "inputRefEnvio", "inputRefDestinatario", "inputObservacoes"
    ];


    inputIds.forEach((id, i) => {
      document.getElementById(id).addEventListener("input", () => {
        document.getElementById(spanIds[i]).innerHTML =
          document.getElementById(id).value.replace(/\n/g, '<br>');
      });
    });



      const now = new Date();
      const invoiceNumber = `INV-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}${now.getSeconds().toString().padStart(2,'0')}`;
      document.getElementById("inputNumeroFatura").value = invoiceNumber;
      document.getElementById("numeroFatura").textContent = invoiceNumber;

      const remetentePadrao = `NR SHOP COMERCIAL LDTA\nRua Eduardo Fernandes Filho, N° 101 - Sala 01\nBairro Guamium - Piracicaba/SP CEP: 13413-036\nCNPJ: 39.475.936/0001-04 - IE: 535.825.640.112\nTel: +55 19 2532-0020`;

      const inputRemetente = document.getElementById("inputRemetente");
      inputRemetente.value = remetentePadrao;
      document.getElementById("remetente").innerHTML = remetentePadrao.replace(/\n/g, "<br>");
    });

    ["qty", "unit"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        const qty = parseFloat(document.getElementById("qty").value) || 0;
        const unit = parseFloat(document.getElementById("unit").value) || 0;
        const totalCalc = qty * unit;
        document.getElementById("total").value = totalCalc.toFixed(2);
      });
    });

    ["shippingValue", "otherCostsValue"].forEach(id => {
    document.getElementById(id).addEventListener("input", atualizarTotais);
  });



    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const content = document.getElementById("invoiceContent");

        const pdf = new jsPDF("p", "mm", "a4");
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 5; 

        const canvas = await html2canvas(content, {
          scale: 2,
          useCORS: true
        });

        const imgFullWidth = canvas.width;
        const imgFullHeight = canvas.height;

        const imgPDFWidth = pageWidth - margin * 2;
        const imgPDFHeight = imgPDFWidth * (imgFullHeight / imgFullWidth);

        const pageHeightPx = Math.floor((canvas.width * (pageHeight - margin * 2)) / imgPDFWidth);

        const ctx = canvas.getContext("2d");
        const totalPages = Math.ceil(imgFullHeight / pageHeightPx);

        for (let i = 0; i < totalPages; i++) {
          const pageCanvas = document.createElement("canvas");
          const pageContext = pageCanvas.getContext("2d");

          const overlap = 20; // px de sobreposição entre páginas
          const sourceY = i * pageHeightPx - (i > 0 ? overlap : 0);
          const sliceHeight = (i === totalPages - 1)
            ? imgFullHeight - sourceY
            : pageHeightPx + (i > 0 ? overlap : 0);

          pageCanvas.width = imgFullWidth;
          pageCanvas.height = sliceHeight;

          pageContext.drawImage(
            canvas,
            0, sourceY,
            imgFullWidth, sliceHeight,
            0, 0,
            imgFullWidth, sliceHeight
          );

              const imgData = pageCanvas.toDataURL("image/png");
                  if (i > 0) pdf.addPage();
                pdf.addImage(imgData, "PNG", margin, margin, imgPDFWidth, (sliceHeight * imgPDFWidth) / imgFullWidth);
        }

            pdf.save("commercial_invoice.pdf");
      }


    function atualizarLogo() {
      const selected = document.getElementById("companySelect").value;
      const logoPaths = {
        bid: "images/BID_IMPORT_logo_enhanced.png",
        easy: "images/easy.png",
        nr: "images/nr.jpg"
      };
      const logo = logoPaths[selected] || logoPaths.bid;
      document.getElementById("companyLogo").src = logo;
      document.getElementById("companyLogoPdf").src = logo;
    }

  </script>



</body>
</html>
