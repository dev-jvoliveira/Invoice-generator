<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Commercial Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link
      rel="icon"
      type="image/x-icon"
      href="images/BID_IMPORT_logo_enhanced.ico"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        font-size: 12px;
        background: #e6e6e6;
        margin: 0;
      }

      #invoiceContent {
        width: 794px;
        min-height: 1123px;
        padding: 20px;
        margin: auto;
        background: white;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      h1 {
        text-align: center;
        margin-bottom: 10px;
        font-size: 18px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        table-layout: fixed;
      }

      th,
      td {
        border: 1px solid black;
        padding: 5px;
        text-align: left;
        word-wrap: break-word;
        word-break: break-word;
      }

      th:nth-child(1),
      td:nth-child(1) {
        width: 4%;
      } /* Item */
      th:nth-child(2),
      td:nth-child(2) {
        width: 25%;
      } /* Description */
      th:nth-child(3),
      td:nth-child(3) {
        width: 5%;
      } /* QTY */
      th:nth-child(4),
      td:nth-child(4) {
        width: 7%;
      } /* Unit of Measure */
      th:nth-child(5),
      td:nth-child(5) {
        width: 10%;
      } /* Net Weight */
      th:nth-child(6),
      td:nth-child(6) {
        width: 10%;
      } /* Gross Weight */
      th:nth-child(7),
      td:nth-child(7) {
        width: 13%;
      } /* Country /Terr. of MFR */
      th:nth-child(8),
      td:nth-child(8) {
        width: 10%;
      } /* Unit Price */
      th:nth-child(9),
      td:nth-child(9) {
        width: 10%;
      } /* Subtotal */

      .section {
        margin-top: 5px;
      }
      .flex {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .signature {
        display: flex;
        justify-content: space-between;
      }

      .input-area,
      .add-item-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
        margin-top: 5px;
      }

      label {
        display: flex;
        flex-direction: column;
        font-weight: bold;
      }

      input,
      textarea {
        padding: 4px;
        font-size: 12px;
      }

      .add-button,
      .remove-button {
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
        color: white;
        background-color: orangered;
      }

      .export-button {
        margin: 3px auto;
        display: block;
        padding: 3px 12px;
        font-size: 13px;
        cursor: pointer;
        color: white;
        background-color: #0051ff;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        grid-column: span 2;
      }

      .footer-fixed {
        padding-top: 10px;
        border-top: 1px solid #ccc;
        margin-top: 40px;
      }

      h5 {
        margin: 2px 0;
        font-weight: normal;
      }

      .exporter {
        padding: 6px;
        border: 1px solid #000;
        width: 48%;
      }

      .botao-salvar {
        background-color: #28a745;
        color: white;
        border: 1 solid #000;
        padding: 5px;
      }

      .botao-carregar {
        background-color: #ffc107;
        color: black;
        border: 1 solid #000;
        padding: 5px;
      }

      .botao-excluir {
        background-color: #dc3545;
        color: white;
        border: 1 solid #000;
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <!-- Campo de seleção da empresa -->
    <label style="display: block; text-align: center; margin-bottom: 10px">
      Company:
      <select
        id="companySelect"
        onchange="atualizarLogo()"
        style="margin-left: 10px; font-size: 12px"
      >
        <option value="bid">BID IMPORT</option>
        <option value="easy">EASYSHOP</option>
        <option value="nr">NRSHOP</option>
      </select>
    </label>

    <img
      id="companyLogo"
      src="images/nr.jpg"
      alt="Company Logo"
      style="display: block; margin: 20px auto; max-width: 150px"
    />

    <!-- Área de preenchimento -->
    <div class="input-area">
      <div style="display: flex; gap: 10px; align-items: flex-end">
        <label style="flex: 1">
          Exporter:
          <textarea id="inputRemetente" rows="2"></textarea>
        </label>

        <label style="min-width: 120px">
          Currency:
          <select id="inputMoeda">
            <option value="USD" selected>USD</option>
            <option value="EUR">EUR</option>
            <option value="BRL">BRL</option>
            <option value="GBP">GBP</option>
            <option value="JPY">JPY</option>
          </select>
        </label>
      </div>
      <label
        >Recipient:<textarea id="inputDestinatario" rows="2"></textarea>
      </label>
    </div>
    <hr />

    <p><strong>Add Item</strong></p>
    <div class="add-item-group">
      <label>Description:<input id="desc" /></label>
      <label>QTY:<input id="qty" /></label>
      <label>Unit of Measure:<input id="unitMeasure" /></label>
      <label>Net Weight (kg):<input id="code" /></label>
      <label>Gross Weight (kg):<input id="weight" /></label>
      <label>Country /Terr. of MFR:<input id="countryMfr" /></label>
      <label>Unit Price:<input id="unit" /></label>
      <label>Total:<input id="total" readonly /></label>
      <div class="action-buttons">
        <button class="add-button" onclick="addItem()">Add Item</button>
        <button class="remove-button" onclick="removeLastItem()">
          Remove Last Item
        </button>
      </div>
    </div>
    <hr />

    <div><span>Test</span></div>

    <div class="input-area" style="margin-top: 10px">
      <label
        >Ship Date:
        <input id="inputShipDate" type="date" />
      </label>
      <label
        >Air Waybill No. / Tracking No.:
        <input id="inputTracking" />
      </label>
      <label
        >Invoice No.:
        <input id="inputInvoiceNo" />
      </label>
      <label
        >Purpose of Shipment:
        <input id="inputPurpose" />
      </label>
    </div>

    <hr />

    <p><strong>Consignee</strong></p>
    <div class="input-area" style="margin-top: 10px">
      <label
        >TAX ID# | CPF/CNPJ:
        <input id="inputTaxId" />
      </label>
      <label
        >Contact Name:
        <input id="inputContactName" />
      </label>
      <label
        >Telephone No.:
        <input id="inputPhone" />
      </label>
      <label
        >E-mail:
        <input id="inputEmail" type="email" />
      </label>
      <label
        >Company Name:
        <input id="inputCompanyName" />
      </label>
      <label
        >Company Address:
        <input id="inputCompanyAddress" />
      </label>
      <label
        >Ctry/Terr:
        <input id="inputCountry" />
      </label>
    </div>

    <hr />
    <p><strong>Sold To (Se diferente do Consignee)</strong></p>
    <div class="input-area" style="margin-top: 10px">
      <label
        >TAX ID# | CPF/CNPJ:
        <input id="inputSoldTaxId" />
      </label>
      <label
        >Company Name:
        <input id="inputSoldCompanyName" />
      </label>
      <label
        >Company Address:
        <input id="inputSoldCompanyAddress" />
      </label>
      <label
        >Ctry/Terr:
        <input id="inputSoldCountry" />
      </label>
      <label>
        Custom Information:
        <input id="inputSoldCustomInfo" />
      </label>
      <label>
        Additional Notes:
        <input id="inputSoldNotes" />
      </label>
    </div>

    <!-- Botão para copiar os dados do Consignee -->
    <div style="text-align: right; margin: 5px 0">
      <button
        onclick="copiarConsigneeParaSoldTo()"
        style="
          padding: 6px 10px;
          font-size: 12px;
          background-color: #28a745;
          color: white;
          border: 1px solid #000;
          cursor: pointer;
        "
      >
        Copiar dados do Consignee
      </button>
    </div>

    <hr />

    <div class="input-area" style="max-width: 300px; margin: 0 auto">
      <label>
        <br />Shipping:
        <input
          id="shippingValue"
          type="number"
          step="0.01"
          value="0.00"
          style="text-align: right"
        />
      </label>
      <label>
        Other Costs:
        <input
          id="otherCostsValue"
          type="number"
          step="0.01"
          value="0.00"
          style="text-align: right"
        />
      </label>
    </div>
    <br />
    <hr />
    <p><strong>Bank Details</strong></p>
    <div class="input-area">
      <label>Beneficiary Name:<input id="inputBeneficiaryName" /></label>
      <label>IBAN:<input id="inputIban" /></label>
      <label>Bank Name:<input id="inputBankName" /></label>
      <label>SWIFT Code:<input id="inputSwiftCode" /></label>
      <label>Account Number:<input id="inputAccountNumber" /></label>
      <label>Intermediary Bank:<input id="inputIntermediary" /></label>
      <label
        >SWIFT Code (Intermediary):<input id="inputIntermediarySwift"
      /></label>
    </div>
    <hr />
    <br />

    <button class="export-button" onclick="exportPDF()">Export to PDF</button>

    <div style="text-align: center; margin: 15px">
      <button class="export-button botao-salvar" onclick="salvarFatura()">
        Salvar Fatura
      </button>
      <button class="export-button botao-carregar" onclick="carregarFatura()">
        Carregar Fatura
      </button>
      <button class="export-button botao-excluir" onclick="excluirFatura()">
        Excluir Fatura
      </button>
    </div>

    <br />
    <hr />

    <!-- INVOICE A4 INTEIRA COM LOGO, TABELA E INSTRUÇÕES BANCÁRIAS -->
    <div id="invoiceContent">
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-evenly;
          margin-bottom: 4px;
        "
      >
        <img
          id="companyLogoPdf"
          src="images/nr.jpg"
          alt="Company Logo"
          style="max-width: 150px"
        />
        <h1 style="margin: 0; font-size: 26px">Commercial Invoice</h1>
      </div>

      <!-- Linha 1: Exporter + Ship Info -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          gap: 10px;
          margin-top: 4px;
        "
      >
        <!-- Exporter -->
        <div
          style="flex: 1; border: 1px solid #000; padding: 8px; font-size: 12px"
        >
          <strong>Exporter:</strong><br />
          <span id="remetente"></span>
        </div>

        <!-- Ship Info -->
        <div
          style="flex: 1; border: 1px solid #000; padding: 8px; font-size: 12px"
        >
          <div style="margin-bottom: 4px">
            <strong>Ship Date:</strong> <span id="shipDatePdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>Tracking No.:</strong> <span id="trackingPdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>Invoice No.:</strong> <span id="invoiceNoPdf"></span>
          </div>
          <div>
            <strong>Purpose of Shipment:</strong> <span id="purposePdf"></span>
          </div>
        </div>
      </div>

      <!-- Linha 2: Consignee + Sold To -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          gap: 10px;
          margin-top: 6px;
        "
      >
        <!-- Consignee -->
        <div
          style="flex: 1; border: 1px solid #000; padding: 8px; font-size: 12px"
        >
          <strong>Consignee</strong><br /><br />
          <div style="margin-bottom: 4px">
            <strong>TAX ID# | CPF/CNPJ:</strong> <span id="taxIdPdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>Contact Name:</strong> <span id="contactNamePdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>Telephone No.:</strong> <span id="phonePdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>E-mail:</strong> <span id="emailPdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>Company Name:</strong> <span id="companyNamePdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>Company Address:</strong>
            <span id="companyAddressPdf"></span>
          </div>
          <div><strong>Ctry/Terr:</strong> <span id="countryPdf"></span></div>
        </div>

        <!-- Sold To -->
        <div
          style="flex: 1; border: 1px solid #000; padding: 8px; font-size: 12px"
        >
          <strong>Sold To</strong><br /><br />

          <div style="margin-bottom: 4px">
            <strong>TAX ID# | CPF/CNPJ:</strong> <span id="soldTaxIdPdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>Company Name:</strong> <span id="soldCompanyNamePdf"></span>
          </div>
          <div style="margin-bottom: 4px">
            <strong>Company Address:</strong>
            <span id="soldCompanyAddressPdf"></span>
          </div>
          <div>
            <strong>Ctry/Terr:</strong> <span id="soldCountryPdf"></span>
          </div>
          <div style="margin-top: 4px">
            <strong>Custom Information:</strong>
            <span id="soldCustomInfoPdf"></span>
          </div>
          <div style="margin-top: 4px">
            <strong>Additional Notes:</strong>
            <span id="soldNotesPdf"></span>
          </div>
        </div>
      </div>

      <table id="tabelaItens">
        <thead>
          <tr>
            <th>Item</th>
            <th>Description</th>
            <th>QTY</th>
            <th>Unit of Measure</th>
            <th>Net Weight (kg)</th>
            <th>Gross Weight (kg)</th>
            <th>Country /Terr. of MFR</th>
            <th>Unit Price</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <br />

      <div
        style="
          display: flex;
          justify-content: space-between;
          gap: 20px;
          margin-top: 10px;
          align-items: flex-start;
        "
      >
        <!-- Declaração à esquerda -->
        <div style="flex: 1">
          <div style="border: 1px solid black; font-size: 11px; padding: 8px">
            <strong>Declaration:</strong><br />
            I declare that all the information contained in this invoice to be
            true and correct.
          </div>
          <!-- Frase fora da borda -->
          <div
            style="
              margin-top: 5px;
              font-size: 11px;
              border: 1px solid #000;
              padding: 8px;
            "
          >
            Originator or Name of Company Representative if the invoice is being
            completed on behalf of a company or individual.
            <br />
            <hr />
            <strong>NR Shop Comercial</strong>
          </div>
        </div>

        <!-- Totais à direita -->
        <div
          style="
            width: 300px;
            font-size: 12px;
            border: 1px solid black;
            padding: 10px;
            background-color: #f9f9f9;
          "
        >
          <div style="display: flex; justify-content: space-between">
            <strong>Currency:</strong>
            <span id="moeda">USD</span>
          </div>

          <div style="display: flex; justify-content: space-between">
            <strong>SUB TOTAL:</strong>
            <span id="subtotalFinal">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-top: 5px;
            "
          >
            <strong>Shipping:</strong>
            <span id="shippingDisplay">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-top: 5px;
            "
          >
            <strong>Other Costs:</strong>
            <span id="otherCostsDisplay">$0.00</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-top: 5px;
            "
          >
            <strong>Total Net Weight:</strong>
            <span id="pesoLiquidoTotal"> 0.00 kg</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-top: 5px;
            "
          >
            <strong>Total Gross Weight:</strong>
            <span id="pesoBrutoTotal"> 0.00 kg</span>
          </div>
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-top: 8px;
              border-top: 1px solid #ccc;
              padding-top: 5px;
            "
          >
            <strong>Invoice Total:</strong>
            <span id="grandTotal">$0.00</span>
          </div>
        </div>
      </div>

      <hr />

      <!-- BLOCO BANCÁRIO DINÂMICO -->
      <div
        style="
          border: 1px solid #800000;
          padding: 10px;
          margin-top: 10px;
          font-size: 11px;
        "
      >
        <h3
          style="
            text-align: center;
            background-color: #800000;
            color: white;
            margin: 0 0 5px 0;
            padding: 4px;
            font-size: 12px;
          "
        >
          BANK REFERENCES / WIRE INSTRUCTIONS - USD CITI
        </h3>

        <div
          style="
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            line-height: 1.6;
          "
        >
          <div
            style="flex: 1 1 48%; padding-right: 10px; box-sizing: border-box"
          >
            <strong>Beneficiary Name:</strong>
            <span id="beneficiaryNamePdf"></span><br />
            <strong>IBAN:</strong> <span id="ibanPdf"></span><br />
            <strong>Bank Name:</strong> <span id="bankNamePdf"></span><br />
            <strong>SWIFT CODE:</strong> <span id="swiftCodePdf"></span><br />
          </div>
          <div
            style="flex: 1 1 48%; padding-left: 10px; box-sizing: border-box"
          >
            <strong>Account Number:</strong> <span id="accountNumberPdf"></span
            ><br />
            <strong>Intermediary Bank (if any):</strong>
            <span id="intermediaryPdf"></span><br />
            <strong>SWIFT CODE:</strong> <span id="intermediarySwiftPdf"></span
            ><br />
          </div>
        </div>
      </div>

      <!-- Teste de alteração -->
    </div>

    <script>
      // Atualizar campos dinâmicos
      const camposAdicionais = [
        { input: "inputMoeda", span: "moeda" },
        { input: "inputIncoterms", span: "incoterms" },
        { input: "inputRazaoExportacao", span: "razaoExportacao" },
        { input: "inputTipoExportacao", span: "tipoExportacao" },
        { input: "inputTransportador", span: "transportador" },
      ];

      camposAdicionais.forEach(({ input, span }) => {
        document.getElementById(input).addEventListener("input", () => {
          document.getElementById(span).textContent =
            document.getElementById(input).value;
        });
      });
    </script>

    <script>
      const tbody = document.querySelector("#tabelaItens tbody");
      let itemCount = 0;

      function addItem() {
        itemCount++;

        const subtotalValue =
          parseFloat(document.getElementById("total").value) || 0;
        const moedaSelecionada =
          document.getElementById("inputMoeda").value || "USD";

        // Mapeia locais por moeda para formatação correta
        const localePorMoeda = {
          USD: "en-US",
          EUR: "de-DE",
          BRL: "pt-BR",
          GBP: "en-GB",
          JPY: "ja-JP",
        };
        const locale = localePorMoeda[moedaSelecionada] || "en-US";

        const subtotalFormatted = new Intl.NumberFormat(locale, {
          style: "currency",
          currency: moedaSelecionada,
        }).format(subtotalValue);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${itemCount}</td>
          <td>${desc.value}</td>
          <td>${qty.value}</td>
          <td>${unitMeasure.value}</td>
          <td>${code.value}</td>
          <td>${weight.value}</td>
          <td>${countryMfr.value}</td>
          <td>${unit.value}</td>
          <td>${subtotalFormatted}</td>
        `;
        tbody.appendChild(tr);

        atualizarTotais();
      }

      function removeLastItem() {
        if (tbody.lastChild) {
          tbody.removeChild(tbody.lastChild);
          itemCount--;
          atualizarTotais();
        }
      }

      function atualizarTotais() {
        let pesoLiquidoTotal = 0;
        let pesoBrutoTotal = 0;
        let valorTotalFatura = 0;

        [...tbody.children].forEach((tr) => {
          pesoLiquidoTotal += parseFloat(tr.children[4].textContent) || 0;
          pesoBrutoTotal += parseFloat(tr.children[5].textContent) || 0;
          const subtotal = tr.children[8].textContent
            .replace(/[^\d,.-]+/g, "") // remove símbolo da moeda
            .replace(",", "."); // troca vírgula por ponto
          valorTotalFatura += parseFloat(subtotal) || 0;
        });

        document.getElementById("pesoLiquidoTotal").textContent =
          pesoLiquidoTotal.toFixed(2) + " kg";
        document.getElementById("pesoBrutoTotal").textContent =
          pesoBrutoTotal.toFixed(2) + " kg";

        const moeda = document.getElementById("inputMoeda").value || "USD";
        document.getElementById("moeda").textContent = moeda;

        const formatador = new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: moeda,
        });

        const shipping =
          parseFloat(document.getElementById("shippingValue").value) || 0;
        const other =
          parseFloat(document.getElementById("otherCostsValue").value) || 0;
        const grandTotal = valorTotalFatura + shipping + other;

        document.getElementById("subtotalFinal").textContent =
          formatador.format(valorTotalFatura);
        document.getElementById("shippingDisplay").textContent =
          formatador.format(shipping);
        document.getElementById("otherCostsDisplay").textContent =
          formatador.format(other);
        document.getElementById("grandTotal").textContent =
          formatador.format(grandTotal);
      }

      const inputIds = [
        // "inputData", "inputNumeroFatura",
        "inputRemetente",
        "inputDestinatario", //"inputRefEnvio", "inputRefDestinatario", "inputObservacoes"
      ];

      const spanIds = [
        // "data", "numeroFatura",
        "remetente",
        "destinatario",
        "refEnvio",
        "refDestinatario",
        "observacoes",
      ];

      inputIds.forEach((id, i) => {
        document.getElementById(id).addEventListener("input", () => {
          document.getElementById(spanIds[i]).innerHTML = document
            .getElementById(id)
            .value.replace(/\n/g, "<br>");
        });
      });

      window.addEventListener("DOMContentLoaded", () => {
        // Preenche o remetente padrão
        const remetentePadrao = `NR SHOP COMERCIAL LDTA\nRua Eduardo Fernandes Filho, N° 101 - Sala 01\nBairro Guamium - Piracicaba/SP CEP: 13413-036\nCNPJ: 39.475.936/0001-04 - IE: 535.825.640.112\nTel: +55 19 2532-0020`;
        const inputRemetente = document.getElementById("inputRemetente");
        inputRemetente.value = remetentePadrao;
        document.getElementById("remetente").innerHTML =
          remetentePadrao.replace(/\n/g, "<br>");

        // Sincroniza campos do CONSIGNEE com a folha A4
        const camposConsignee = [
          { input: "inputTaxId", span: "taxIdPdf" },
          { input: "inputContactName", span: "contactNamePdf" },
          { input: "inputPhone", span: "phonePdf" },
          { input: "inputEmail", span: "emailPdf" },
          { input: "inputCompanyName", span: "companyNamePdf" },
          { input: "inputCompanyAddress", span: "companyAddressPdf" },
          { input: "inputCountry", span: "countryPdf" },
        ];
        camposConsignee.forEach(({ input, span }) => {
          document.getElementById(input).addEventListener("input", () => {
            document.getElementById(span).textContent =
              document.getElementById(input).value;
          });
        });

        // Sincroniza campos do SOLD TO com a folha A4
        const soldToCampos = [
          { input: "inputSoldTaxId", span: "soldTaxIdPdf" },
          { input: "inputSoldCompanyName", span: "soldCompanyNamePdf" },
          { input: "inputSoldCompanyAddress", span: "soldCompanyAddressPdf" },
          { input: "inputSoldCountry", span: "soldCountryPdf" },
          { input: "inputSoldCustomInfo", span: "soldCustomInfoPdf" },
          { input: "inputSoldNotes", span: "soldNotesPdf" },
        ];
        soldToCampos.forEach(({ input, span }) => {
          document.getElementById(input).addEventListener("input", () => {
            document.getElementById(span).textContent =
              document.getElementById(input).value;
          });
        });

        // Torna a função visível ao botão onclick
        window.copiarConsigneeParaSoldTo = function () {
          document.getElementById("inputSoldTaxId").value =
            document.getElementById("inputTaxId").value;
          document.getElementById("inputSoldCompanyName").value =
            document.getElementById("inputCompanyName").value;
          document.getElementById("inputSoldCompanyAddress").value =
            document.getElementById("inputCompanyAddress").value;
          document.getElementById("inputSoldCountry").value =
            document.getElementById("inputCountry").value;

          // Dispara os eventos de input para atualizar os spans da folha A4
          soldToCampos.forEach(({ input }) => {
            document.getElementById(input).dispatchEvent(new Event("input"));
          });
        };

        const camposExtras = [
          { input: "inputShipDate", span: "shipDatePdf" },
          { input: "inputTracking", span: "trackingPdf" },
          { input: "inputInvoiceNo", span: "invoiceNoPdf" },
          { input: "inputPurpose", span: "purposePdf" },
        ];

        camposExtras.forEach(({ input, span }) => {
          document.getElementById(input).addEventListener("input", () => {
            document.getElementById(span).textContent =
              document.getElementById(input).value;
          });
        });

        const camposBanco = [
          { input: "inputBeneficiaryName", span: "beneficiaryNamePdf" },
          { input: "inputIban", span: "ibanPdf" },
          { input: "inputBankName", span: "bankNamePdf" },
          { input: "inputSwiftCode", span: "swiftCodePdf" },
          { input: "inputAccountNumber", span: "accountNumberPdf" },
          { input: "inputIntermediary", span: "intermediaryPdf" },
          { input: "inputIntermediarySwift", span: "intermediarySwiftPdf" },
        ];

        camposBanco.forEach(({ input, span }) => {
          document.getElementById(input).addEventListener("input", () => {
            document.getElementById(span).textContent =
              document.getElementById(input).value;
          });
        });
      });

      document.getElementById("inputMoeda").addEventListener("input", () => {
        document.getElementById("moeda").textContent =
          document.getElementById("inputMoeda").value;
      });

      // Cálculo automático do total por item (qty × unit)
      ["qty", "unit"].forEach((id) => {
        document.getElementById(id).addEventListener("input", () => {
          const qty = parseFloat(document.getElementById("qty").value) || 0;
          const unit = parseFloat(document.getElementById("unit").value) || 0;
          const totalCalc = qty * unit;
          document.getElementById("total").value = totalCalc.toFixed(2);
        });
      });

      // Atualiza totais da fatura quando frete ou outros custos mudarem
      ["shippingValue", "otherCostsValue"].forEach((id) => {
        document.getElementById(id).addEventListener("input", atualizarTotais);
      });

      async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const content = document.getElementById("invoiceContent");

        const pdf = new jsPDF("p", "mm", "a4");
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 5;

        const canvas = await html2canvas(content, {
          scale: 2,
          useCORS: true,
        });

        const imgFullWidth = canvas.width;
        const imgFullHeight = canvas.height;

        const imgPDFWidth = pageWidth - margin * 2;
        const imgPDFHeight = imgPDFWidth * (imgFullHeight / imgFullWidth);

        const pageHeightPx = Math.floor(
          (canvas.width * (pageHeight - margin * 2)) / imgPDFWidth
        );

        const ctx = canvas.getContext("2d");
        const totalPages = Math.ceil(imgFullHeight / pageHeightPx);

        for (let i = 0; i < totalPages; i++) {
          const pageCanvas = document.createElement("canvas");
          const pageContext = pageCanvas.getContext("2d");

          const overlap = 20; // px de sobreposição entre páginas
          const sourceY = i * pageHeightPx - (i > 0 ? overlap : 0);
          const sliceHeight =
            i === totalPages - 1
              ? imgFullHeight - sourceY
              : pageHeightPx + (i > 0 ? overlap : 0);

          pageCanvas.width = imgFullWidth;
          pageCanvas.height = sliceHeight;

          pageContext.drawImage(
            canvas,
            0,
            sourceY,
            imgFullWidth,
            sliceHeight,
            0,
            0,
            imgFullWidth,
            sliceHeight
          );

          const imgData = pageCanvas.toDataURL("image/png");
          if (i > 0) pdf.addPage();
          pdf.addImage(
            imgData,
            "PNG",
            margin,
            margin,
            imgPDFWidth,
            (sliceHeight * imgPDFWidth) / imgFullWidth
          );
        }

        pdf.save("commercial_invoice.pdf");
      }

      function atualizarLogo() {
        const selected = document.getElementById("companySelect").value;
        const logoPaths = {
          bid: "images/BID_IMPORT_logo_enhanced.png",
          easy: "images/easy.png",
          nr: "images/nr.jpg",
        };
        const logo = logoPaths[selected] || logoPaths.bid;
        document.getElementById("companyLogo").src = logo;
        document.getElementById("companyLogoPdf").src = logo;
      }
    </script>

    <script>
      function salvarFatura() {
        const campos = [
          "inputRemetente",
          "inputDestinatario",
          "inputShipDate",
          "inputTracking",
          "inputInvoiceNo",
          "inputPurpose",
          "inputTaxId",
          "inputContactName",
          "inputPhone",
          "inputEmail",
          "inputCompanyName",
          "inputCompanyAddress",
          "inputCountry",
          "inputSoldTaxId",
          "inputSoldCompanyName",
          "inputSoldCompanyAddress",
          "inputSoldCountry",
          "shippingValue",
          "otherCostsValue",

          // Campos bancários adicionados
          "inputBeneficiaryName",
          "inputIban",
          "inputBankName",
          "inputSwiftCode",
          "inputAccountNumber",
          "inputIntermediary",
          "inputIntermediarySwift",
        ];

        const dados = {};
        campos.forEach((id) => {
          const elemento = document.getElementById(id);
          if (elemento) {
            dados[id] = elemento.value;
          }
        });

        // Itens da fatura
        dados.itens = [];
        [...document.querySelectorAll("#tabelaItens tbody tr")].forEach(
          (tr) => {
            const cols = [...tr.children].map((td) => td.textContent);
            dados.itens.push(cols);
          }
        );

        localStorage.setItem("faturaSalva", JSON.stringify(dados));
        alert("Fatura salva com sucesso.");
      }

      function carregarFatura() {
        const dados = JSON.parse(localStorage.getItem("faturaSalva"));
        if (!dados) return alert("Nenhuma fatura salva encontrada.");

        const campos = Object.keys(dados).filter((k) => k !== "itens");
        campos.forEach((id) => {
          if (document.getElementById(id)) {
            document.getElementById(id).value = dados[id];
            document.getElementById(id).dispatchEvent(new Event("input"));
          }
        });

        // Recarregar itens na tabela
        dados.itens.forEach((item) => {
          const tr = document.createElement("tr");
          itemCount++;
          tr.innerHTML = `
        <td>${itemCount}</td>
        <td>${item[1]}</td>
        <td>${item[2]}</td>
        <td>${item[3]}</td>
        <td>${item[4]}</td>
        <td>${item[5]}</td>
        <td>${item[6]}</td>
        <td>${item[7]}</td>
        <td>${item[8]}</td>
      `;
          tbody.appendChild(tr);
        });

        atualizarTotais();
      }

      function excluirFatura() {
        if (confirm("Tem certeza que deseja excluir a fatura salva?")) {
          localStorage.removeItem("faturaSalva");
          alert("Fatura excluída com sucesso.");
        }
      }
    </script>
  </body>
</html>
